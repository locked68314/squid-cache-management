---
- name: Compilar código fuente
  hosts: squid_compile
  become: true

  tasks:
    - name: Descargar código fuente
      ansible.builtin.get_url:
        url: "https://www.squid-cache.org/Versions/v7/squid-7.0.0-20250103-rb56774dd09.tar.gz"
        dest: "/tmp/squid.tar.gz"
      
    - name: Extraer ficheros
      ansible.builtin.unarchive:
        src: "/tmp/squid.tar.gz"
        dest: "/tmp/"
        mode: "0644"
        owner: root
        group: root
        remote_src: true
        list_files: true
      register: result_file

    - name: Dar permisos de ejecución a scripts necesarios
      ansible.builtin.file:
        path: "/tmp/{{ result_file.get('files') | first }}/configure"
        mode: "0744"

    - name: Ejecutar ./configure con flags definidos
      ansible.builtin.command: ./configure {{ squid_configure_flags | join(' ') }}
      args:
        chdir: "/tmp/{{ result_file.get('files') | first }}"